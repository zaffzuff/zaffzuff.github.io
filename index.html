<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tekyildiz App - Testnet</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
    const PiSDK = window.Pi;

    const BACKEND_BASE = "https://tekyildiz-testnet.vercel.app";

    async function pay1Pi() {
      const scopes = ["payments"];

      await PiSDK.authenticate(scopes, (payment) => {
        console.log("Incomplete payment found:", payment);
      });

      const paymentData = {
        amount: 1,
        memo: "Tekyildiz Test Payment",
        metadata: { purpose: "step10" },
      };

      const paymentCallbacks = {
        onReadyForServerApproval: async function (paymentId) {
          const r = await fetch(`${BACKEND_BASE}/api/approve-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId }),
          });

          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data?.error || "approve failed");
        },

        onReadyForServerCompletion: async function (paymentId, txid) {
          const r = await fetch(`${BACKEND_BASE}/api/complete-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, txid }),
          });

          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data?.error || "complete failed");

          alert("Payment completed ✅");
        },

        onCancel: function (paymentId) {
          console.log("Cancelled:", paymentId);
        },

        onError: function (error, payment) {
          console.error("Payment error:", error, payment);
          alert("Payment error: " + (error?.message || error));
        },
      };

      await PiSDK.createPayment(paymentData, paymentCallbacks);
    }
  </script>
</head>
<body>
  <h1>Tekyildiz App – Testnet</h1>
  <button onclick="pay1Pi()">Pay 1 Pi (Test)</button>
</body>
</html>
